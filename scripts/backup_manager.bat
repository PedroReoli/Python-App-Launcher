@echo off
setlocal enabledelayedexpansion

REM ========================================
REM üíæ SISTEMA DE BACKUP E RESTAURA√á√ÉO AVAN√áADO
REM ========================================
REM Vers√£o: 1.0.0 - BACKUP INTELIGENTE
REM Autor: Python App Launcher Team
REM ========================================

chcp 65001 >nul 2>&1
color 0E

echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë                    üíæ SISTEMA DE BACKUP AVAN√áADO                             ‚ïë
echo ‚ïë                                                                              ‚ïë
echo ‚ïë  üîí Criptografia + Compress√£o + Backup Inteligente + Restaura√ß√£o R√°pida    ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

REM ========================================
REM 1. VERIFICA√á√ÉO DE ARGUMENTOS
REM ========================================

set "BACKUP_MODE="
set "RESTORE_MODE="
set "AUTO_BACKUP="
set "ENCRYPTED_BACKUP="
set "COMPRESSED_BACKUP="
set "BACKUP_NAME="

for %%a in (%*) do (
    if "%%a"=="--backup" set "BACKUP_MODE=true"
    if "%%a"=="--restore" set "RESTORE_MODE=true"
    if "%%a"=="--auto" set "AUTO_BACKUP=true"
    if "%%a"=="--encrypt" set "ENCRYPTED_BACKUP=true"
    if "%%a"=="--compress" set "COMPRESSED_BACKUP=true"
    if "%%a:~0,2%"=="--" (
        set "BACKUP_NAME=%%a:~2%"
    )
)

REM Definir nome padr√£o se n√£o especificado
if not defined BACKUP_NAME set "BACKUP_NAME=backup_%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%%time:~6,2%"
set "BACKUP_NAME=%BACKUP_NAME: =0%"

REM ========================================
REM 2. CRIA√á√ÉO DE BACKUP
REM ========================================

if defined BACKUP_MODE (
    echo üìã [1/4] Iniciando backup avan√ßado...
    echo.
    
    REM Criar diret√≥rio de backup se n√£o existir
    if not exist "backups" mkdir backups
    if not exist "backups\%BACKUP_NAME%" mkdir "backups\%BACKUP_NAME%"
    
    echo üíæ Criando backup: %BACKUP_NAME%
    echo üìÅ Local: backups\%BACKUP_NAME%
    echo.
    
    REM Backup de arquivos de configura√ß√£o
    echo üìÑ Backup de configura√ß√µes...
    if exist "config.json" (
        copy "config.json" "backups\%BACKUP_NAME%\" >nul
        echo ‚úÖ config.json
    )
    if exist "requirements.txt" (
        copy "requirements.txt" "backups\%BACKUP_NAME%\" >nul
        echo ‚úÖ requirements.txt
    )
    if exist "metadata.json" (
        copy "metadata.json" "backups\%BACKUP_NAME%\" >nul
        echo ‚úÖ metadata.json
    )
    
    REM Backup de dados
    echo üìä Backup de dados...
    if exist "data" (
        xcopy "data" "backups\%BACKUP_NAME%\data\" /E /I /Y >nul
        echo ‚úÖ Dados da aplica√ß√£o
    )
    
    REM Backup de logs
    echo üìù Backup de logs...
    if exist "logs" (
        xcopy "logs" "backups\%BACKUP_NAME%\logs\" /E /I /Y >nul
        echo ‚úÖ Logs do sistema
    )
    
    REM Backup de documenta√ß√£o
    echo üìö Backup de documenta√ß√£o...
    if exist "docs" (
        xcopy "docs" "backups\%BACKUP_NAME%\docs\" /E /I /Y >nul
        echo ‚úÖ Documenta√ß√£o
    )
    
    REM Backup de aplica√ß√µes
    echo üöÄ Backup de aplica√ß√µes...
    if exist "Apps" (
        xcopy "Apps" "backups\%BACKUP_NAME%\Apps\" /E /I /Y >nul
        echo ‚úÖ Aplica√ß√µes Python
    )
    
    REM Backup de sistema de IA
    echo ü§ñ Backup de sistema de IA...
    if exist "bot" (
        xcopy "bot" "backups\%BACKUP_NAME%\bot\" /E /I /Y >nul
        echo ‚úÖ Sistema de IA
    )
    
    REM Criar arquivo de metadados do backup
    echo üìã Criando metadados do backup...
    (
        echo ========================================
        echo METADADOS DO BACKUP - %date% %time%
        echo ========================================
        echo.
        echo NOME: %BACKUP_NAME%
        echo DATA: %date%
        echo HORA: %time%
        echo.
        echo ARQUIVOS INCLU√çDOS:
        echo - config.json
        echo - requirements.txt
        echo - metadata.json
        echo - data/ (dados da aplica√ß√£o)
        echo - logs/ (logs do sistema)
        echo - docs/ (documenta√ß√£o)
        echo - Apps/ (aplica√ß√µes Python)
        echo - bot/ (sistema de IA)
        echo.
        echo CONFIGURA√á√ïES:
        echo - Criptografado: %ENCRYPTED_BACKUP%
        echo - Comprimido: %COMPRESSED_BACKUP%
        echo - Autom√°tico: %AUTO_BACKUP%
        echo.
        echo SISTEMA:
        echo - OS: %OS%
        echo - Arquitetura: %PROCESSOR_ARCHITECTURE%
        echo - Usu√°rio: %USERNAME%
        echo.
        echo VERS√ÉO:
        echo - Python App Launcher: 4.0.0
        echo - Backup Manager: 1.0.0
    ) > "backups\%BACKUP_NAME%\backup_info.txt"
    
    REM Compress√£o se solicitada
    if defined COMPRESSED_BACKUP (
        echo üì¶ Comprimindo backup...
        powershell -Command "& {Compress-Archive -Path 'backups\%BACKUP_NAME%' -DestinationPath 'backups\%BACKUP_NAME%.zip' -Force}" >nul 2>&1
        if exist "backups\%BACKUP_NAME%.zip" (
            rmdir /s /q "backups\%BACKUP_NAME%" >nul 2>&1
            echo ‚úÖ Backup comprimido: %BACKUP_NAME%.zip
        )
    )
    
    REM Criptografia se solicitada
    if defined ENCRYPTED_BACKUP (
        echo üîí Criptografando backup...
        echo ‚ö†Ô∏è  Funcionalidade de criptografia ser√° implementada em vers√£o futura
        echo üí° Por enquanto, o backup est√° seguro no diret√≥rio local
    )
    
    echo.
    echo ‚úÖ Backup criado com sucesso!
    echo üìÅ Local: backups\%BACKUP_NAME%
    if defined COMPRESSED_BACKUP echo üì¶ Arquivo: backups\%BACKUP_NAME%.zip
    echo.
)

REM ========================================
REM 3. RESTAURA√á√ÉO DE BACKUP
REM ========================================

if defined RESTORE_MODE (
    echo üìã [2/4] Iniciando restaura√ß√£o de backup...
    echo.
    
    REM Listar backups dispon√≠veis
    if exist "backups" (
        echo üìÅ Backups dispon√≠veis:
        echo.
        dir /B /AD backups
        echo.
        
        if not defined BACKUP_NAME (
            set /p "BACKUP_CHOICE=Digite o nome do backup para restaurar: "
        ) else (
            set "BACKUP_CHOICE=%BACKUP_NAME%"
        )
        
        REM Verificar se backup existe
        if exist "backups\%BACKUP_CHOICE%" (
            echo üîÑ Restaurando backup: %BACKUP_CHOICE%
            echo.
            
            REM Fazer backup do estado atual antes de restaurar
            echo üíæ Criando backup de seguran√ßa do estado atual...
            set "SAFETY_BACKUP=safety_%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%%time:~6,2%"
            set "SAFETY_BACKUP=%SAFETY_BACKUP: =0%"
            mkdir "backups\%SAFETY_BACKUP%" >nul 2>&1
            
            REM Backup de seguran√ßa
            if exist "config.json" copy "config.json" "backups\%SAFETY_BACKUP%\" >nul
            if exist "data" xcopy "data" "backups\%SAFETY_BACKUP%\data\" /E /I /Y >nul
            echo ‚úÖ Backup de seguran√ßa criado: %SAFETY_BACKUP%
            echo.
            
            REM Restaurar arquivos
            echo üîÑ Restaurando arquivos...
            
            if exist "backups\%BACKUP_CHOICE%\config.json" (
                copy "backups\%BACKUP_CHOICE%\config.json" "." >nul
                echo ‚úÖ config.json restaurado
            )
            
            if exist "backups\%BACKUP_CHOICE%\requirements.txt" (
                copy "backups\%BACKUP_CHOICE%\requirements.txt" "." >nul
                echo ‚úÖ requirements.txt restaurado
            )
            
            if exist "backups\%BACKUP_CHOICE%\metadata.json" (
                copy "backups\%BACKUP_CHOICE%\metadata.json" "." >nul
                echo ‚úÖ metadata.json restaurado
            )
            
            if exist "backups\%BACKUP_CHOICE%\data" (
                if exist "data" rmdir /s /q "data" >nul 2>&1
                xcopy "backups\%BACKUP_CHOICE%\data" "data\" /E /I /Y >nul
                echo ‚úÖ Dados restaurados
            )
            
            if exist "backups\%BACKUP_CHOICE%\logs" (
                if exist "logs" rmdir /s /q "logs" >nul 2>&1
                xcopy "backups\%BACKUP_CHOICE%\logs" "logs\" /E /I /Y >nul
                echo ‚úÖ Logs restaurados
            )
            
            if exist "backups\%BACKUP_CHOICE%\docs" (
                if exist "docs" rmdir /s /q "docs" >nul 2>&1
                xcopy "backups\%BACKUP_CHOICE%\docs" "docs\" /E /I /Y >nul
                echo ‚úÖ Documenta√ß√£o restaurada
            )
            
            if exist "backups\%BACKUP_CHOICE%\Apps" (
                if exist "Apps" rmdir /s /q "Apps" >nul 2>&1
                xcopy "backups\%BACKUP_CHOICE%\Apps" "Apps\" /E /I /Y >nul
                echo ‚úÖ Aplica√ß√µes restauradas
            )
            
            if exist "backups\%BACKUP_CHOICE%\bot" (
                if exist "bot" rmdir /s /q "bot" >nul 2>&1
                xcopy "backups\%BACKUP_CHOICE%\bot" "bot\" /E /I /Y >nul
                echo ‚úÖ Sistema de IA restaurado
            )
            
            echo.
            echo ‚úÖ Restaura√ß√£o conclu√≠da com sucesso!
            echo üíæ Backup de seguran√ßa: %SAFETY_BACKUP%
            echo.
            
        ) else (
            echo ‚ùå Backup '%BACKUP_CHOICE%' n√£o encontrado!
            echo.
            echo üí° Backups dispon√≠veis:
            dir /B /AD backups
            echo.
        )
    ) else (
        echo ‚ùå Nenhum backup encontrado!
        echo.
    )
)

REM ========================================
REM 4. BACKUP AUTOM√ÅTICO
REM ========================================

if defined AUTO_BACKUP (
    echo üìã [3/4] Configurando backup autom√°tico...
    echo.
    
    REM Criar script de backup autom√°tico
    echo üîß Criando script de backup autom√°tico...
    
    (
        echo @echo off
        echo REM Backup autom√°tico do Python App Launcher
        echo REM Executar: backup_manager.bat --backup --auto
        echo.
        echo set "BACKUP_NAME=auto_%%date:~-4,4%%%%date:~-10,2%%%%date:~-7,2%%_%%time:~0,2%%%%time:~3,2%%%%time:~6,2%%"
        echo set "BACKUP_NAME=%%BACKUP_NAME: =0%%"
        echo.
        echo if not exist "backups" mkdir backups
        echo if not exist "backups\%%BACKUP_NAME%%" mkdir "backups\%%BACKUP_NAME%%"
        echo.
        echo echo Backup autom√°tico: %%BACKUP_NAME%%
        echo.
        echo if exist "config.json" copy "config.json" "backups\%%BACKUP_NAME%%\" ^>nul
        echo if exist "data" xcopy "data" "backups\%%BACKUP_NAME%%\data\" /E /I /Y ^>nul
        echo if exist "logs" xcopy "logs" "backups\%%BACKUP_NAME%%\logs\" /E /I /Y ^>nul
        echo.
        echo echo Backup autom√°tico conclu√≠do: %%BACKUP_NAME%%
    ) > "auto_backup.bat"
    
    echo ‚úÖ Script de backup autom√°tico criado: auto_backup.bat
    echo.
    echo üí° Para agendar backup autom√°tico:
    echo    1. Abra o Agendador de Tarefas do Windows
    echo    2. Crie uma nova tarefa
    echo    3. Configure para executar auto_backup.bat
    echo    4. Defina frequ√™ncia (di√°ria, semanal, etc.)
    echo.
)

REM ========================================
REM 5. GERENCIAMENTO DE BACKUPS
REM ========================================

if not defined BACKUP_MODE if not defined RESTORE_MODE if not defined AUTO_BACKUP (
    echo üìã [4/4] Gerenciamento de backups...
    echo.
    
    if exist "backups" (
        echo üìÅ Backups existentes:
        echo.
        for /f "tokens=1,2,3,4" %%a in ('dir /T:C /O:D /B backups 2^>nul') do (
            echo üìÑ %%a - %%b %%c %%d
        )
        echo.
        
        REM Estat√≠sticas
        echo üìä Estat√≠sticas:
        for /f %%a in ('dir /B /AD backups 2^>nul ^| find /c /v ""') do set "BACKUP_COUNT=%%a"
        echo    Total de backups: %BACKUP_COUNT%
        
        REM Calcular tamanho total
        echo üîç Calculando tamanho total...
        powershell -Command "& {$size = (Get-ChildItem -Path 'backups' -Recurse -File | Measure-Object -Property Length -Sum).Sum; Write-Host ('Tamanho total: {0:N2} MB' -f ($size/1MB))}" 2>nul
        
        echo.
        echo üí° Comandos dispon√≠veis:
        echo    backup_manager.bat --backup [nome]     (criar backup)
        echo    backup_manager.bat --restore [nome]    (restaurar backup)
        echo    backup_manager.bat --auto              (configurar backup autom√°tico)
        echo    backup_manager.bat --compress          (backup comprimido)
        echo    backup_manager.bat --encrypt           (backup criptografado)
        echo.
    ) else (
        echo üìÅ Nenhum backup encontrado.
        echo.
        echo üí° Para criar seu primeiro backup:
        echo    backup_manager.bat --backup
        echo.
    )
)

REM ========================================
REM 6. FINALIZA√á√ÉO
REM ========================================

echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë                    üíæ SISTEMA DE BACKUP AVAN√áADO                             ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

echo üìã Recursos dispon√≠veis:
echo    üíæ Backup completo da aplica√ß√£o
echo    üîÑ Restaura√ß√£o r√°pida e segura
echo    üì¶ Compress√£o autom√°tica
echo    üîí Criptografia (em desenvolvimento)
echo    ü§ñ Backup autom√°tico agendado
echo    üìä Gerenciamento inteligente
echo    üí° Backup de seguran√ßa autom√°tico
echo.

echo üéØ Pr√≥ximos passos:
echo    1. Execute start.bat para usar a aplica√ß√£o
echo    2. Configure backup autom√°tico se necess√°rio
echo    3. Monitore o espa√ßo em disco
echo    4. Fa√ßa backups regulares
echo.

pause 